<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowerBoss CRM</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #4CAF50; /* –ó–µ–ª–µ–Ω—ã–π */
            --danger: #ff5252; /* –ö—Ä–∞—Å–Ω—ã–π */
            --accent: #2979FF; /* –°–∏–Ω–∏–π */
            --warning: #FFC107; /* –ñ–µ–ª—Ç—ã–π */
            --text-main: #ffffff;
            --text-sec: #b0b0b0;
            --input-bg: #2c2c2c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            padding: 15px 20px;
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 700; }

        .container { padding: 15px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-accent { background: var(--accent); }
        .btn-small { width: auto; padding: 8px 12px; font-size: 14px; border-radius: 8px; }
        .btn-icon { width: 35px; height: 35px; padding: 0; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; border: none; color: white; cursor: pointer; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-sec); margin-bottom: 6px; font-size: 13px; }
        input, select, textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid #333;
            color: white;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            font-family: inherit;
        }
        input:focus { border-color: var(--primary); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .item-info h3 { margin: 0 0 4px 0; font-size: 16px; }
        .item-info p { margin: 0; font-size: 13px; color: var(--text-sec); }
        .item-actions { display: flex; align-items: center; gap: 8px; }

        /* –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞ */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .status-new { background: var(--accent); color: white; }
        .status-ready { background: var(--warning); color: black; }
        .status-done { background: var(--primary); color: white; }

        /* –ò—Ç–æ–≥–æ–≤–∞—è –ø–ª–∞—à–∫–∞ */
        .total-bar {
            background: #252525;
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            border: 1px solid #333;
        }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #bbb; }
        .total-main { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444; font-size: 18px; font-weight: bold; color: white; }
        .profit { color: var(--primary); }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1a1a1a;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
            z-index: 900;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        .nav-item { background: none; border: none; color: #666; text-align: center; font-size: 10px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 3px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            align-items: flex-end; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #1e1e1e; width: 100%; max-width: 500px;
            padding: 25px 20px; border-radius: 20px 20px 0 0;
            animation: slideUp 0.3s; box-sizing: border-box;
            max-height: 85vh; overflow-y: auto;
        }
        @media(min-width: 600px) { .modal-content { border-radius: 20px; margin-bottom: auto; margin-top: 80px; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .counter { display: flex; align-items: center; gap: 10px; background: #2c2c2c; padding: 5px; border-radius: 8px; }
        .counter span { width: 20px; text-align: center; font-weight: bold; }

        .view { display: none; }
        .view.active { display: block; }
        .empty-state { text-align: center; color: #555; margin-top: 40px; }
    </style>
</head>
<body>

    <!-- –®–ê–ü–ö–ê -->
    <div class="header">
        <h1 id="page-title">–°–∫–ª–∞–¥</h1>
        <button class="btn btn-small" id="header-btn" onclick="handleHeaderBtn()">+ –¢–æ–≤–∞—Ä</button>
    </div>

    <div class="container">
        
        <!-- 1. –°–ö–õ–ê–î -->
        <div id="view-warehouse" class="view active">
            <div class="input-group">
                <input type="text" id="search-warehouse" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderWarehouse()">
            </div>
            <div id="warehouse-list"></div>
        </div>

        <!-- 2. –°–ë–û–†–ö–ê –ë–£–ö–ï–¢–ê -->
        <div id="view-calc" class="view">
            <div id="bouquet-list">
                <div class="empty-state">–ë—É–∫–µ—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ü–≤–µ—Ç—ã!</div>
            </div>

            <!-- –ò–¢–û–ì–ò -->
            <div class="total-bar" id="calc-total" style="display:none;">
                <div class="total-row"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</span> <span id="total-cost">0 ‚ÇΩ</span></div>
                <div class="total-main"><span>–ò—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—É:</span> <span id="total-price" style="color:var(--accent)">0 ‚ÇΩ</span></div>
                <div class="total-row" style="margin-top:5px; color:#4CAF50"><span>–ü—Ä–∏–±—ã–ª—å:</span> <span id="total-profit">0 ‚ÇΩ</span></div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="openAddFlowerModal()">+ –î–æ–±–∞–≤–∏—Ç—å –≤ –±—É–∫–µ—Ç</button>
                <button class="btn btn-danger" onclick="clearBouquet()" style="width: auto;">üóë</button>
            </div>
            <button class="btn btn-accent" id="btn-checkout" style="margin-top:10px; display:none;" onclick="openCheckoutModal()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <!-- 3. –ó–ê–ö–ê–ó–´ -->
        <div id="view-orders" class="view">
            <div id="orders-list">
                <div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
        </div>

        <!-- 4. –ö–õ–ò–ï–ù–¢–´ -->
        <div id="view-clients" class="view">
            <div class="input-group">
                <input type="text" id="search-clients" placeholder="üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..." oninput="renderClients()">
            </div>
            <div id="clients-list">
                <div class="empty-state">–ë–∞–∑–∞ –ø—É—Å—Ç–∞</div>
            </div>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('warehouse')"><span class="nav-icon">üì¶</span>–°–∫–ª–∞–¥</button>
        <button class="nav-item" onclick="switchTab('calc')"><span class="nav-icon">üå∏</span>–°–±–æ—Ä–∫–∞</button>
        <button class="nav-item" onclick="switchTab('orders')"><span class="nav-icon">üìã</span>–ó–∞–∫–∞–∑—ã</button>
        <button class="nav-item" onclick="switchTab('clients')"><span class="nav-icon">üë•</span>–ö–ª–∏–µ–Ω—Ç—ã</button>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –¢–û–í–ê–† (–°–ö–õ–ê–î) -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 style="margin-top:0;">–¢–æ–≤–∞—Ä</h2>
            <input type="hidden" id="item-id">
            <div class="input-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="item-name"></div>
            <div style="display:flex; gap:10px;">
                <div class="input-group" style="flex:1"><label>–ó–∞–∫—É–ø (‚ÇΩ)</label><input type="number" id="item-cost"></div>
                <div class="input-group" style="flex:1"><label>–ü—Ä–æ–¥–∞–∂–∞ (‚ÇΩ)</label><input type="number" id="item-price"></div>
            </div>
            <div class="input-group"><label>–û—Å—Ç–∞—Ç–æ–∫</label><input type="number" id="item-qty"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="closeModal('itemModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –°–ü–ò–°–ê–ù–ò–ï (–ë–†–ê–ö) -->
    <div class="modal" id="writeOffModal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:var(--danger)">üìâ –°–ø–∏—Å–∞–Ω–∏–µ</h2>
            <p id="writeoff-item-name" style="color:#888; margin-bottom:15px;"></p>
            <input type="hidden" id="writeoff-item-id">
            
            <div class="input-group">
                <label>–°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ —Å–ø–∏—Å–∞—Ç—å?</label>
                <input type="number" id="writeoff-qty" placeholder="1" value="1">
            </div>
            <div class="input-group">
                <label>–ü—Ä–∏—á–∏–Ω–∞</label>
                <select id="writeoff-reason">
                    <option value="–ó–∞–≤—è–ª">ü•Ä –ó–∞–≤—è–ª / –ë—Ä–∞–∫</option>
                    <option value="–°–ª–æ–º–∞–ª–∏">üíî –°–ª–æ–º–∞–ª–∏</option>
                    <option value="–ü–æ–¥–∞—Ä–æ–∫">üéÅ –ü–æ–¥–∞—Ä–æ–∫ / –†–µ–∫–ª–∞–º–∞</option>
                    <option value="–†–µ–≤–∏–∑–∏—è">üîç –û—à–∏–±–∫–∞ —Ä–µ–≤–∏–∑–∏–∏</option>
                </select>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" onclick="confirmWriteOff()">–°–ø–∏—Å–∞—Ç—å</button>
                <button class="btn" style="background:#444" onclick="closeModal('writeOffModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –í–´–ë–û–† –¶–í–ï–¢–ö–ê -->
    <div class="modal" id="selectFlowerModal">
        <div class="modal-content">
            <h2 style="margin-top:0;">–î–æ–±–∞–≤–∏—Ç—å</h2>
            <div class="input-group">
                <input type="text" id="search-picker" placeholder="–ù–∞–π—Ç–∏ —Ü–≤–µ—Ç–æ–∫..." oninput="renderFlowerPicker()">
            </div>
            <div id="flower-picker-list" style="max-height: 350px; overflow-y: auto;"></div>
            <button class="btn btn-danger" style="margin-top:15px;" onclick="closeModal('selectFlowerModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <h2 style="margin-top:0;">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
            <div class="input-group">
                <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input type="text" id="client-name" placeholder="–ò–≤–∞–Ω">
            </div>
            <div class="input-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="client-phone" placeholder="+7 900...">
            </div>
            <div class="input-group">
                <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—ã–¥–∞—á–∏</label>
                <input type="datetime-local" id="order-date">
            </div>
            <div class="input-group">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ê–¥—Ä–µ—Å)</label>
                <textarea id="order-comment" rows="3" style="width:100%; background:#2c2c2c; color:white; border:1px solid #333; padding:10px; border-radius:10px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-accent" onclick="confirmOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="btn btn-danger" onclick="closeModal('checkoutModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // --- –î–ê–ù–ù–´–ï ---
        let warehouseData = JSON.parse(localStorage.getItem('flowerData')) || [];
        let ordersData = JSON.parse(localStorage.getItem('flowerOrders')) || [];
        let clientsData = JSON.parse(localStorage.getItem('flowerClients')) || [];
        
        let currentBouquet = []; // –ö–æ—Ä–∑–∏–Ω–∞

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        renderWarehouse();
        renderOrders();
        renderClients();

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function switchTab(tab) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            
            const titles = { 'warehouse': '–°–∫–ª–∞–¥', 'calc': '–°–±–æ—Ä–∫–∞', 'orders': '–ó–∞–∫–∞–∑—ã', 'clients': '–ö–ª–∏–µ–Ω—Ç—ã' };
            document.getElementById('page-title').innerText = titles[tab];
            
            const btn = document.getElementById('header-btn');
            if (tab === 'warehouse') {
                btn.style.display = 'block';
                btn.innerText = '+ –¢–æ–≤–∞—Ä';
                btn.onclick = () => openModal('itemModal');
            } else {
                btn.style.display = 'none';
            }

            const tabs = ['warehouse', 'calc', 'orders', 'clients'];
            document.querySelectorAll('.nav-item')[tabs.indexOf(tab)].classList.add('active');

            if (tab === 'calc') renderBouquet();
            if (tab === 'orders') renderOrders();
            if (tab === 'clients') renderClients();
        }

        // --- –°–ö–õ–ê–î ---
        function renderWarehouse() {
            const list = document.getElementById('warehouse-list');
            const search = document.getElementById('search-warehouse').value.toLowerCase();
            list.innerHTML = '';
            const filtered = warehouseData.filter(item => item.name.toLowerCase().includes(search));

            if (filtered.length === 0) return list.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ</div>';

            filtered.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.className = 'card';
                // –ö–Ω–æ–ø–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ (—Å—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ üìâ)
                el.innerHTML = `
                    <div class="item-info">
                        <h3>${item.name}</h3>
                        <p>–ó–∞–∫—É–ø: ${item.cost} | –ü—Ä–æ–¥: <span style="color:var(--primary)">${item.price}</span></p>
                    </div>
                    <div class="item-actions">
                        <div class="badge">${item.qty}</div>
                        <button class="btn-icon" style="background:#2c2c2c; color:#ff5252;" onclick="openWriteOff(${item.id})" title="–°–ø–∏—Å–∞—Ç—å">üìâ</button>
                        <button class="btn-icon" style="background:#333;" onclick="editItem(${item.id})">‚úé</button>
                        <button class="btn-icon btn-danger" onclick="deleteItem(${item.id})">√ó</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function saveItem() {
            const id = document.getElementById('item-id').value;
            const item = {
                id: id ? Number(id) : Date.now(),
                name: document.getElementById('item-name').value.trim(),
                cost: Number(document.getElementById('item-cost').value),
                price: Number(document.getElementById('item-price').value),
                qty: Number(document.getElementById('item-qty').value)
            };
            if (!item.name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');

            if (id) {
                const idx = warehouseData.findIndex(x => x.id == id);
                warehouseData[idx] = item;
            } else {
                warehouseData.push(item);
            }
            localStorage.setItem('flowerData', JSON.stringify(warehouseData));
            closeModal('itemModal');
            renderWarehouse();
        }

        function editItem(id) {
            const item = warehouseData.find(x => x.id == id);
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-cost').value = item.cost;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-qty').value = item.qty;
            openModal('itemModal');
        }

        function deleteItem(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) {
                warehouseData = warehouseData.filter(x => x.id != id);
                localStorage.setItem('flowerData', JSON.stringify(warehouseData));
                renderWarehouse();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –°–ü–ò–°–ê–ù–ò–Ø ---
        function openWriteOff(id) {
            const item = warehouseData.find(x => x.id == id);
            document.getElementById('writeoff-item-id').value = id;
            document.getElementById('writeoff-item-name').innerText = `–°–ø–∏—Å—ã–≤–∞–µ–º: ${item.name} (–î–æ—Å—Ç—É–ø–Ω–æ: ${item.qty})`;
            document.getElementById('writeoff-qty').value = 1;
            openModal('writeOffModal');
        }

        function confirmWriteOff() {
            const id = Number(document.getElementById('writeoff-item-id').value);
            const qty = Number(document.getElementById('writeoff-qty').value);
            const reason = document.getElementById('writeoff-reason').value;

            if (qty <= 0) return alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');

            const index = warehouseData.findIndex(x => x.id == id);
            if (index !== -1) {
                if(warehouseData[index].qty < qty) return alert('–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç —Å—Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–∞!');
                
                warehouseData[index].qty -= qty;
                localStorage.setItem('flowerData', JSON.stringify(warehouseData));
                
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥ —Å–ø–∏—Å–∞–Ω–∏–π –≤ –±—É–¥—É—â–µ–º, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–º–µ–Ω—å—à–∞–µ–º —Å—Ç–æ–∫
                alert(`–°–ø–∏—Å–∞–Ω–æ: ${qty} —à—Ç. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`);
            }
            
            closeModal('writeOffModal');
            renderWarehouse();
        }

        // --- –°–ë–û–†–ö–ê (–ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†) ---
        function openAddFlowerModal() {
            document.getElementById('search-picker').value = '';
            openModal('selectFlowerModal');
            renderFlowerPicker();
        }

        function renderFlowerPicker() {
            const list = document.getElementById('flower-picker-list');
            const search = document.getElementById('search-picker').value.toLowerCase();
            list.innerHTML = '';
            const filtered = warehouseData.filter(item => item.name.toLowerCase().includes(search));

            if(filtered.length === 0) { list.innerHTML = '<div style="text-align:center; color:#555">–ü—É—Å—Ç–æ</div>'; return; }

            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'card';
                el.style.marginBottom = '8px';
                const stockColor = item.qty > 0 ? '#888' : '#ff5252';
                
                el.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b>${item.name}</b> 
                            <div style="font-size:12px; color:${stockColor}">–ù–∞ —Å–∫–ª–∞–¥–µ: ${item.qty}</div>
                            <div style="font-size:12px; color:#888">${item.price}‚ÇΩ</div>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:8px;">
                        <input type="number" id="qty-picker-${item.id}" value="1" min="1" style="width:60px; padding:8px; height:35px; border-radius:5px;">
                        <button class="btn-small" onclick="addToBouquet(${item.id})">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function addToBouquet(id) {
            const item = warehouseData.find(x => x.id == id);
            const qtyInput = document.getElementById(`qty-picker-${id}`);
            const qtyToAdd = Number(qtyInput.value) || 1;

            if(item.qty < qtyToAdd) {
                if(!confirm(`–ù–∞ —Å–∫–ª–∞–¥–µ –≤—Å–µ–≥–æ ${item.qty}, –∞ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ ${qtyToAdd}. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) return;
            }
            
            const existing = currentBouquet.find(x => x.id == id);
            if (existing) { existing.qty += qtyToAdd; } 
            else { currentBouquet.push({ ...item, qty: qtyToAdd }); }
            
            closeModal('selectFlowerModal');
            renderBouquet();
        }

        function renderBouquet() {
            const list = document.getElementById('bouquet-list');
            const totalBar = document.getElementById('calc-total');
            const checkoutBtn = document.getElementById('btn-checkout');
            list.innerHTML = '';

            if (currentBouquet.length === 0) {
                list.innerHTML = '<div class="empty-state">–ë—É–∫–µ—Ç –ø—É—Å—Ç</div>';
                totalBar.style.display = 'none';
                checkoutBtn.style.display = 'none';
                return;
            }

            totalBar.style.display = 'block';
            checkoutBtn.style.display = 'flex';
            let totalCost = 0, totalPrice = 0;

            currentBouquet.forEach((item, index) => {
                totalCost += item.cost * item.qty;
                totalPrice += item.price * item.qty;
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="item-info"><h3>${item.name}</h3><p>${item.price} ‚ÇΩ x ${item.qty} = <span style="color:white">${item.price * item.qty} ‚ÇΩ</span></p></div>
                    <div class="counter">
                        <button class="btn-icon" style="width:25px; height:25px; background:#444;" onclick="changeBouquetQty(${index}, -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="btn-icon" style="width:25px; height:25px; background:#444;" onclick="changeBouquetQty(${index}, 1)">+</button>
                    </div>
                `;
                list.appendChild(el);
            });

            document.getElementById('total-cost').innerText = totalCost + ' ‚ÇΩ';
            document.getElementById('total-price').innerText = totalPrice + ' ‚ÇΩ';
            const profit = totalPrice - totalCost;
            document.getElementById('total-profit').innerText = (profit > 0 ? '+' : '') + profit + ' ‚ÇΩ';
            document.getElementById('total-profit').style.color = profit >= 0 ? '#4CAF50' : '#ff5252';
        }

        function changeBouquetQty(index, delta) {
            currentBouquet[index].qty += delta;
            if (currentBouquet[index].qty <= 0) currentBouquet.splice(index, 1);
            renderBouquet();
        }

        function clearBouquet() {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { currentBouquet = []; renderBouquet(); }
        }

        // --- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ---
        function openCheckoutModal() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const dateStr = now.toISOString().slice(0, 16);
            document.getElementById('order-date').value = dateStr;
            openModal('checkoutModal');
        }

        function confirmOrder() {
            const name = document.getElementById('client-name').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const date = document.getElementById('order-date').value;
            const comment = document.getElementById('order-comment').value;

            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞!');

            let cost = 0, price = 0;
            currentBouquet.forEach(i => { cost += i.cost * i.qty; price += i.price * i.qty; });

            const order = {
                id: Date.now(),
                client: name,
                phone: phone,
                date: date,
                comment: comment,
                items: currentBouquet,
                total: price,
                cost: cost,
                profit: price - cost,
                status: 'new',
                createdAt: new Date().toISOString()
            };

            const existingClient = clientsData.find(c => c.phone === phone && phone !== '');
            if (!existingClient) {
                clientsData.push({ id: Date.now(), name, phone, ordersCount: 1, lastOrder: date });
            } else {
                existingClient.ordersCount++;
                existingClient.lastOrder = date;
            }
            localStorage.setItem('flowerClients', JSON.stringify(clientsData));

            currentBouquet.forEach(bItem => {
                const wItem = warehouseData.find(w => w.id === bItem.id);
                if (wItem) wItem.qty -= bItem.qty;
            });
            localStorage.setItem('flowerData', JSON.stringify(warehouseData));

            ordersData.push(order);
            localStorage.setItem('flowerOrders', JSON.stringify(ordersData));

            currentBouquet = [];
            document.getElementById('client-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('order-comment').value = '';
            closeModal('checkoutModal');
            
            renderWarehouse();
            renderClients();
            switchTab('orders');
        }

        // --- –ó–ê–ö–ê–ó–´ ---
        function renderOrders() {
            const list = document.getElementById('orders-list');
            list.innerHTML = '';
            if (ordersData.length === 0) return list.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';

            const statusNames = { 'new': '–ù–æ–≤—ã–π', 'ready': '–ì–æ—Ç–æ–≤', 'done': '–í—ã–¥–∞–Ω' };
            const statusClasses = { 'new': 'status-new', 'ready': 'status-ready', 'done': 'status-done' };

            ordersData.slice().reverse().forEach(order => {
                const d = new Date(order.date);
                const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString().slice(0,5);

                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="card-row">
                        <div>
                            <span class="status-badge ${statusClasses[order.status]}">${statusNames[order.status]}</span>
                            <span style="font-size:12px; color:#888; margin-left:10px;">#${order.id.toString().slice(-4)}</span>
                        </div>
                        <b style="font-size:18px;">${order.total} ‚ÇΩ</b>
                    </div>
                    <div style="margin-top:10px;">
                        <h3 style="margin:0;">${order.client}</h3>
                        <p style="color:#888; font-size:13px;">üìÖ ${dateStr}</p>
                        <p style="color:#aaa; font-size:13px; margin-top:5px;">${order.comment || ''}</p>
                        <div style="font-size:12px; color:#666; margin-top:5px;">–ü—Ä–∏–±—ã–ª—å: ${order.profit} ‚ÇΩ</div>
                    </div>
                    <div class="card-row" style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                        <button class="btn-small" style="background:#333;" onclick="toggleStatus(${order.id})">–°—Ç–∞—Ç—É—Å ‚û°Ô∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteOrder(${order.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function toggleStatus(id) {
            const order = ordersData.find(o => o.id == id);
            if(order.status === 'new') order.status = 'ready';
            else if(order.status === 'ready') order.status = 'done';
            else return;
            localStorage.setItem('flowerOrders', JSON.stringify(ordersData));
            renderOrders();
        }

        function deleteOrder(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?')) {
                ordersData = ordersData.filter(o => o.id != id);
                localStorage.setItem('flowerOrders', JSON.stringify(ordersData));
                renderOrders();
            }
        }

        // --- –ö–õ–ò–ï–ù–¢–´ ---
        function renderClients() {
            const list = document.getElementById('clients-list');
            const search = document.getElementById('search-clients').value.toLowerCase();
            list.innerHTML = '';
            
            const filtered = clientsData.filter(c => c.name.toLowerCase().includes(search) || (c.phone && c.phone.includes(search)));
            if (filtered.length === 0) return list.innerHTML = '<div class="empty-state">–ü—É—Å—Ç–æ</div>';

            filtered.slice().reverse().forEach(client => {
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="item-info">
                        <h3>${client.name}</h3>
                        <p>${client.phone || '–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</p>
                    </div>
                    <div style="text-align:right;">
                        <div class="badge" style="background:#2c2c2c;">–ó–∞–∫–∞–∑–æ–≤: ${client.ordersCount}</div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function openModal(id) {
            document.getElementById(id).classList.add('open');
            if(id === 'itemModal' && !document.getElementById('item-id').value) {
                document.getElementById('item-name').value = '';
                document.getElementById('item-cost').value = '';
                document.getElementById('item-price').value = '';
                document.getElementById('item-qty').value = '';
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); if(id === 'itemModal') document.getElementById('item-id').value = ''; }

    </script>
</body>
</html>